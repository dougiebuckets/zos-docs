<html lang="en"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>ZeppelinOS Library · zeppelin_os</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta property="og:title" content="ZeppelinOS Library · zeppelin_os"/><meta property="og:type" content="website"/><meta property="og:url" content="https://docs.zeppelinos.org/index.html"/><meta property="og:description" content="`zos-lib` is a library for writing upgradeable smart contracts on Ethereum. It can be used to create an upgradeable on-chain distributed application."/><link rel="shortcut icon" href="/img/favicon.png"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"/><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:100,200,300,400,500,700,400italic,700italic"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><link rel="stylesheet" href="/css/main.css"/></head><body class="sideNavVisible"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/"><img class="logo" src="/img/logo.svg"/><h2 class="headerTitle">zeppelin_os</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li><a href="https://zeppelinos.org" target="_self">Home</a></li><li><a href="/docs/start.html" target="_self">Docs</a></li><li><a href="/docs/climain.html" target="_self">CLI API</a></li><li><a href="/docs/libmain.html" target="_self">Lib API</a></li><li><a href="https://blog.zeppelinos.org" target="_self">Blog</a></li><li><a href="https://github.com/zeppelinos" target="_self">Github</a></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="container docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><i></i></div><h2><i>›</i><span>LIBRARY</span></h2></div><div class="navGroups"><div class="navGroup navGroupActive"><h3>OVERVIEW</h3><ul><li class="navListItem"><a class="navItem" href="/docs/start.html">ZeppelinOS</a></li></ul></div><div class="navGroup navGroupActive"><h3>GUIDES</h3><ul><li class="navListItem"><a class="navItem" href="/docs/setup.html">Setup</a></li><li class="navListItem"><a class="navItem" href="/docs/building-upgradeable.html">Building upgradeable apps</a></li><li class="navListItem"><a class="navItem" href="/docs/building-stdlib.html">Using the stdlib</a></li><li class="navListItem"><a class="navItem" href="/docs/developing.html">Developing stdlibs</a></li><li class="navListItem"><a class="navItem" href="/docs/testing.html">Testing</a></li></ul></div><div class="navGroup navGroupActive"><h3>DEMOS</h3><ul><li class="navListItem"><a class="navItem" href="/docs/basil.html">Basil</a></li><li class="navListItem"><a class="navItem" href="/docs/crafty.html">Crafty</a></li></ul></div><div class="navGroup navGroupActive"><h3>LIBRARY</h3><ul><li class="navListItem navListItemActive"><a class="navItem navItemActive" href="/docs/libstart.html">Library</a></li></ul></div><div class="navGroup navGroupActive"><h3>FURTHER REFERENCE</h3><ul><li class="navListItem"><a class="navItem" href="/docs/apis.html">APIs</a></li><li class="navListItem"><a class="navItem" href="/docs/stdlib.html">OpenZeppelin stdlib</a></li><li class="navListItem"><a class="navItem" href="/docs/advanced.html">Advanced topics</a></li><li class="navListItem"><a class="navItem" href="/docs/whitepaper.html">Whitepaper</a></li></ul></div></div></section></div><script>
          var toggler = document.getElementById('navToggler');
          var nav = document.getElementById('docsNav');
          toggler.onclick = function() {
            nav.classList.toggle('docsSliderActive');
          };
        </script></nav></div><div class="container mainContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1>ZeppelinOS Library</h1></header><article><div><span><p><code>zos-lib</code> is a library for writing upgradeable smart contracts on Ethereum. It can be used to create an upgradeable on-chain distributed application.</p>
<p>Use this library if you want to programmatically develop, deploy or operate an upgradeable smart contract system.</p>
<p>If you want a CLI-aided development experience, see <a href="https://github.com/zeppelinos/zos-cli">the zOS CLI</a>.</p>
<h1><a class="anchor" aria-hidden="true" name="getting-started"></a><a href="#getting-started" aria-hidden="true" class="hash-link" ><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Getting Started</h1>
<p>To install <code>zos-lib</code> simply go to your project's root directory and run:</p>
<pre><code class="hljs css sh">npm i zos-lib
</code></pre>
<p>Next, learn how to:</p>
<ul>
<li><a href="#single">Develop and deploy a single smart contract which can be upgraded</a> (for bugfixing or adding new features).</li>
<li><a href="#complex">Develop and operate a complex upgradeable app</a> with multiple smart contracts which are connected to the zOS upgradeable standard libraries.</li>
</ul>
<h2><a class="anchor" aria-hidden="true" name="a-name-single-a-develop-and-deploy-a-single-upgradeable-smart-contract"></a><a href="#a-name-single-a-develop-and-deploy-a-single-upgradeable-smart-contract" aria-hidden="true" class="hash-link" ><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a name="single"></a> Develop and deploy a single upgradeable smart contract</h2>
<p>Note: This shows a low-level manual method of developing a single upgradeable smart contract. You probably want to use <a href="https://github.com/zeppelinos/zos-cli/blob/master/README.md">the higher-level CLI guide</a>.</p>
<p>To work with a single upgradeable smart contract, we just need to deal with a simple upgradeability proxy. This is a special contract that will hold the storage of our upgradeable contract and redirect function calls to an <code>implementation</code> contract, which we can change (thus making it upgradeable). Let's do the following example to see how it works:</p>
<ol>
<li>Write the first version of the contract in <code>MyContract.sol</code>. Most contracts require some sort of initialization, but upgradeable contracts can't use constructors because the proxy won't know about those values. So we need to use the <code>Initializable</code> pattern provided by <code>zos-lib</code>:</li>
</ol>
<pre><code class="hljs css sol"><span class="hljs-meta"><span class="hljs-meta-keyword">import</span> "zos-lib/contracts/migrations/Initializable.sol";</span>

contract MyContract <span class="hljs-keyword">is</span> Initializable {
  uint256 <span class="hljs-keyword">public</span> x;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">initialize</span><span class="hljs-params">(uint256 _x)</span> <span class="hljs-title">isInitializer</span> <span class="hljs-title">public</span> </span>{
    x = _x;
  }
}
</code></pre>
<ol start="2">
<li>Deploy this version:</li>
</ol>
<pre><code class="hljs css js"><span class="hljs-keyword">const</span> myContract_v0 = <span class="hljs-keyword">await</span> MyContract.new();
</code></pre>
<ol start="3">
<li>Now we need to deploy the proxy that will let us upgrade our contract. Pass the address of the first version to the constructor:</li>
</ol>
<pre><code class="hljs css js"><span class="hljs-keyword">const</span> proxy = <span class="hljs-keyword">await</span> AdminUpgradeabilityProxy.new(myContract_v0.address);
</code></pre>
<ol start="4">
<li>Next, call initialize on the proxy, to initialize the storage variables. Note that you have to wrap the proxy in a <code>MyContract</code> interface, because all calls will be delegated from the proxy to the contract with the implementation.</li>
</ol>
<pre><code class="hljs css js"><span class="hljs-keyword">let</span> myContract = <span class="hljs-keyword">await</span> MyContract.at(proxy.address);
<span class="hljs-keyword">const</span> x0 = <span class="hljs-number">42</span>;
<span class="hljs-keyword">await</span> myContract.initialize(x0);
<span class="hljs-built_in">console</span>.log(<span class="hljs-keyword">await</span> myContract.x()); <span class="hljs-comment">// 42</span>
</code></pre>
<ol start="5">
<li>Let's edit <code>MyContract.sol</code> to add a function called <code>y</code>:</li>
</ol>
<pre><code class="hljs css sol"><span class="hljs-meta"><span class="hljs-meta-keyword">import</span> "zos-lib/contracts/migrations/Initializable.sol";</span>

contract MyContract <span class="hljs-keyword">is</span> Initializable {
  uint256 <span class="hljs-keyword">public</span> x;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">initialize</span><span class="hljs-params">(uint256 _x)</span> <span class="hljs-title">isInitializer</span> <span class="hljs-title">public</span> </span>{
    x = _x;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">y</span><span class="hljs-params">()</span> <span class="hljs-title">public</span> <span class="hljs-title">pure</span> <span class="hljs-title">returns</span> <span class="hljs-params">(uint256)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-number">1337</span>;
  }

}
</code></pre>
<p>Note that when we update our contract's code, we can't change its pre-existing storage structure. This means we can't remove any previously existing contract variable. We can, however, remove functions we don't want to use anymore (in the code shown, all functions were preserved).</p>
<ol start="6">
<li>Next, we deploy our new version, and upgrade our proxy to use this implementation:</li>
</ol>
<pre><code class="hljs css js"><span class="hljs-keyword">const</span> myContract_v1 = <span class="hljs-keyword">await</span> MyContract.new();
<span class="hljs-keyword">await</span> proxy.upgradeTo(myContract_v1.address);
myContract = <span class="hljs-keyword">await</span> MyContract.at(proxy.address);

<span class="hljs-built_in">console</span>.log(<span class="hljs-keyword">await</span> myContract.x()); <span class="hljs-comment">// 42</span>
<span class="hljs-built_in">console</span>.log(<span class="hljs-keyword">await</span> myContract.y()); <span class="hljs-comment">// 1337</span>

</code></pre>
<p>Wohoo! We've upgraded our contract's behavior while preserving it's storage.</p>
<p><a href="examples/single">For a fully working project with this example, see the <code>examples/single</code> folder</a>.
<a href="https://blog.zeppelinos.org/proxy-patterns/">To learn more about how proxies work under the hood, read this post on our blog</a>.</p>
<h2><a class="anchor" aria-hidden="true" name="a-name-complex-a-develop-and-operate-a-complex-upgradeable-app"></a><a href="#a-name-complex-a-develop-and-operate-a-complex-upgradeable-app" aria-hidden="true" class="hash-link" ><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><a name="complex"></a> Develop and operate a complex upgradeable app</h2>
<p>Note: This shows a low-level manual method of developing a complex upgradeable smart contract application. You probably want to use <a href="https://github.com/zeppelinos/zos-cli/blob/master/README.md">the higher-level CLI guide</a> instead, but feel free to continue reading if you want to understand the core contracts of <code>zos-lib</code>.</p>
<p>Most real-world applications require more than a single smart contract. Here's how to build a complex upgradeable app with multiple smart contracts and connect it to the zOS standard libraries:</p>
<ol>
<li>Let's imagine we want to build a simple donation application where we give donors some sort of recognition. An initial version of the contract can look like so:</li>
</ol>
<pre><code class="hljs css sol">pragma solidity ^<span class="hljs-number">0.4</span><span class="hljs-number">.21</span>;

<span class="hljs-keyword">import</span> <span class="hljs-string">"openzeppelin-zos/contracts/ownership/Ownable.sol"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"openzeppelin-zos/contracts/math/SafeMath.sol"</span>;

contract DonationsV1 is Ownable {
  using SafeMath <span class="hljs-keyword">for</span> uint256;

  <span class="hljs-comment">// Keeps a mapping of total donor balances.</span>
  mapping(<span class="hljs-function"><span class="hljs-params">address</span> =&gt;</span> uint256) public donorBalances;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">donate</span>(<span class="hljs-params"></span>) <span class="hljs-title">payable</span> <span class="hljs-title">public</span> </span>{
    <span class="hljs-built_in">require</span>(msg.value &gt; <span class="hljs-number">0</span>);

    <span class="hljs-comment">// Update user donation balance.</span>
    donorBalances[msg.sender] = donorBalances[msg.sender].add(msg.value);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getDonationBalance</span>(<span class="hljs-params">address _donor</span>) <span class="hljs-title">public</span> <span class="hljs-title">view</span> <span class="hljs-title">returns</span> (<span class="hljs-params">uint256</span>) </span>{
    <span class="hljs-keyword">return</span> donorBalances[_donor];
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">withdraw</span>(<span class="hljs-params">address _wallet</span>) <span class="hljs-title">onlyOwner</span> </span>{
    <span class="hljs-comment">// Withdraw all donated funds.</span>
    _wallet.transfer(<span class="hljs-keyword">this</span>.balance);
  }
}
</code></pre>
<ol start="2">
<li>We want to use <code>zos-lib</code> to deploy this contract with upgradeability capabilities. Given this will probably be a complex application and we'll want to use the zOS standard libraries, we'll use the <code>App</code> contract. This contract will live in the blockchain and manage the different versions of our smart contract code and upgradeability proxies. It's the single entry point to manage our application's contract's upgradeability and instances. Let's create and configure it:</li>
</ol>
<pre><code class="hljs css js">  <span class="hljs-comment">// On-chain, single entry point of the entire application.</span>
  log.info(<span class="hljs-string">"&lt;&lt; Setting up App &gt;&gt;"</span>)
  <span class="hljs-keyword">const</span> initialVersion = <span class="hljs-string">'0.0.1'</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> AppDeployer.call(initialVersion)
</code></pre>
<ol start="3">
<li>Next, we need to deploy the first version of the app contracts. To do so, we register the implementation of our <code>DonationsV1</code> in the <code>App</code> and request it to create a new upgradeable proxy for it. Let's do it:</li>
</ol>
<pre><code class="hljs css js">  <span class="hljs-keyword">const</span> contractName = <span class="hljs-string">"Donations"</span>;
  <span class="hljs-keyword">const</span> DonationsV1 = Contracts.getByName(<span class="hljs-string">'DonationsV1'</span>)
  <span class="hljs-keyword">await</span> app.setImplementation(DonationsV1, contractName);
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> app.createProxy(DonationsV1, contractName, <span class="hljs-string">'initialize'</span>, [owner])
</code></pre>
<ol start="4">
<li>Now let's suppose we want to give some sort of retribution to people donating money to our donation campaign. We want to mint new ERC721 cryptocollectibles for every received donation. To do so, we'll link our application to a zOS standard library release that contains an implementation of a mintable ERC721 token. Here's the new contract code:</li>
</ol>
<pre><code class="hljs css sol">pragma solidity ^<span class="hljs-number">0.4</span><span class="hljs-number">.21</span>;

<span class="hljs-meta"><span class="hljs-meta-keyword">import</span> "./DonationsV1.sol";</span>
<span class="hljs-meta"><span class="hljs-meta-keyword">import</span> "openzeppelin-zos/contracts/token/ERC721/MintableERC721Token.sol";</span>

contract DonationsV2 <span class="hljs-keyword">is</span> DonationsV1 {
  using SafeMath <span class="hljs-keyword">for</span> uint256;

  <span class="hljs-comment">// ERC721 non-fungible tokens to be emitted on donations.</span>
  MintableERC721Token <span class="hljs-keyword">public</span> token;
  uint256 <span class="hljs-keyword">public</span> numEmittedTokens;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setToken</span><span class="hljs-params">(MintableERC721Token _token)</span> <span class="hljs-title">external</span> </span>{
    require(_token != address(<span class="hljs-number">0</span>));
    require(token == address(<span class="hljs-number">0</span>));
    token = _token;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">donate</span><span class="hljs-params">()</span> <span class="hljs-title">payable</span> <span class="hljs-title">public</span> </span>{
    <span class="hljs-keyword">super</span>.donate();

    <span class="hljs-comment">// Emit a token.</span>
    token.mint(msg.sender, numEmittedTokens);
    numEmittedTokens = numEmittedTokens.add(<span class="hljs-number">1</span>);
  }
}
</code></pre>
<ol start="5">
<li>What we need to do next is link our application to the zOS standard library release containing that mintable ERC721 implementation, and set it to our upgradeable contract. To do so, we create a new version of our application in the <code>App</code>, register a new <code>AppDirectory</code> containing the new version of our contract implementation, and then set the standard library version of ERC721 to our upgradeable contract. Let's see how:</li>
</ol>
<pre><code class="hljs css js">  <span class="hljs-comment">// Address of the zOS standard library.</span>
  <span class="hljs-keyword">const</span> stdlib = <span class="hljs-string">"0xA739d10Cc20211B973dEE09DB8F0D75736E2D817"</span>;
  <span class="hljs-keyword">const</span> secondVersion = <span class="hljs-string">'0.0.2'</span>
  <span class="hljs-keyword">await</span> app.newVersion(secondVersion, <span class="hljs-keyword">await</span> getStdLib(txParams))
  <span class="hljs-keyword">const</span> DonationsV2 = Contracts.getByName(<span class="hljs-string">'DonationsV2'</span>)
  <span class="hljs-keyword">await</span> app.setImplementation(DonationsV2, contractName);
  <span class="hljs-keyword">await</span> app.upgradeProxy(donations.address, <span class="hljs-literal">null</span>, contractName)
  donations = DonationsV2.at(donations.address)

  <span class="hljs-comment">// Add an ERC721 token implementation to the project, request a proxy for it,</span>
  <span class="hljs-comment">// and set the token on "Donations".</span>
  log.info(<span class="hljs-string">`Creating ERC721 token proxy to use in <span class="hljs-subst">${contractName}</span>...`</span>)
  <span class="hljs-keyword">const</span> token = <span class="hljs-keyword">await</span> app.createProxy(
    MintableERC721Token, 
    tokenClass,
    <span class="hljs-string">'initialize'</span>,
    [donations.address, tokenName, tokenSymbol]
  )
  log.info(<span class="hljs-string">`Token proxy created at <span class="hljs-subst">${token.address}</span>`</span>)
  log.info(<span class="hljs-string">"Setting application's token..."</span>)
  <span class="hljs-keyword">await</span> donations.setToken(token.address, txParams)
  log.info(<span class="hljs-string">"Token set succesfully"</span>)
  <span class="hljs-keyword">return</span> token;
</code></pre>
<p>That's it! We now have the same contract, retaining the original balance, and storage, but with an upgraded code. The upgradeable contract is also linked to an on-chain upgradeable standard library containing an implementation of a mintable ERC721 token. State of the art!</p>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="crafty.html">← Crafty</a><a class="docs-next button" href="apis.html">APIs →</a></div></div></div></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/" class="nav-home"><img src="/img/symbol-zeppelin.png" alt="zeppelin_os" width="66" height="58"/></a><div><h5>Docs</h5><a href="https://docs.zeppelinos.org/docs/building.html">Guides</a><a href="https://docs.zeppelinos.org/docs/clifront.html">Reference</a></div><div><h5>More</h5><a href="https://blog.zeppelinos.org">Blog</a><a href="https://github.com/zeppelinos">Github</a></div></section><a href="https://zeppelinos.org" target="_blank" class="fbOpenSource"><img src="/img/logo.svg" alt="zeppelin_os" width="170" height="45"/></a><section class="copyright">Copyright © 2017 zOS Global</section></footer></div><script>
              (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
              (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
              m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
              })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

              ga('create', 'UA-102575245-1', 'auto');
              ga('send', 'pageview');
            </script></body></html>